<project name="Eclipse SDK build" default="cleanBuild" basedir=".">
	<property file="build.properties" />
	<property file="p2.properties" />
	<available file="bootstrap/plugins" property="bootstrapped" value="true" />

	<target name="cleanBuild" depends="clean,insert-ecf" />

	<target name="clean">
		<delete dir="build" />
	</target>

	<target name="cleanAll" depends="clean">
		<ant antfile="pdebuild.xml" target="clean" />
	</target>

	<target name="bootstrap" unless="bootstrapped">
		<ant antfile="pdebuild.xml" />
	</target>

	<target name="prepareBuildScriptGeneration" depends="bootstrap">
		<delete dir="build" />
		<mkdir dir="build/features" />
		<mkdir dir="build/plugins" />
		<copy todir="build/plugins/">
			<fileset dir="${sdkSource}/plugins/">
				<exclude name="**/*.source_*/" />
			</fileset>
		</copy>
		<copy todir="build/features/">
			<fileset dir="${sdkSource}/features/">
				<exclude name="**/*.source/" />
			</fileset>
		</copy>
		<copy todir="build/plugins/">
			<fileset dir="${sdkSource}/plugins/">
				<include name="org.apache.ant.source_*" />
				<include name="org.apache.commons.codec.source_*" />
				<include name="org.apache.commons.httpclient.source_*" />
				<include name="org.apache.commons.el.source_*" />
				<include name="org.apache.commons.logging.source_*" />
				<include name="com.jcraft.jsch.source_*" />
				<include name="com.ibm.icu.source_*" />
				<include name="org.apache.jasper.source_*" />
				<include name="javax.servlet.source_*" />
				<include name="javax.servlet.jsp.source_*" />
				<include name="org.junit.source_*" />
				<include name="org.objectweb.asm.source_*" />
				<include name="com.ibm.icu.source_*" />
			</fileset>
		</copy>
		<!-- TODO is it really needed -->
		<move tofile="build/plugins/org.junit"
		      file="build/plugins/org.junit_3.8.2.v20090203-1005" />
	</target>

	<target name="generateBuildScripts" depends="prepareBuildScriptGeneration">
		<java classname="org.eclipse.equinox.launcher.Main"
		      fork="true"
		      dir="bootstrap"
		      failonerror="true">
			<classpath>
				<pathelement location="bootstrap/plugins/org.eclipse.equinox.launcher" />
			</classpath>
			<arg line="-configuration configuration " />
			<arg line="-application org.eclipse.ant.core.antRunner " />
			<arg line="-buildfile ../generatebuild-p2.xml" />
			<arg line="-debug -consoleLog " />
			<arg line="-DbuildArch=${buildArch} " />
		</java>
	</target>

	<target name="buildAll" depends="generateBuildScripts">
		<!--FIXME Ugly hack because?  flattenDependencies doesn't work . -->
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.platform"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="build.jars" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
			<property name="javacFailOnError" value="false" />
		</ant>
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.help"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="build.jars" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
		</ant>
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.platform"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="clean" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
			<property name="javacFailOnError" value="false" />
		</ant>
		<!-- END OF HACK -->
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.sdk"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="build.jars" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
		</ant>
	</target>

	<path id="pdebuildClasspath">
		<pathelement location="build/plugins/org.eclipse.pde.build/lib/pdebuild-ant.jar" />
		<pathelement location="build/plugins/org.eclipse.pde.build/pdebuild.jar" />
		<pathelement path="build/plugins/org.eclipse.equinox.common/@dot" />
		<pathelement path="build/plugins/org.eclipse.core.runtime/@dot" />
		<pathelement location="build/plugins/org.eclipse.osgi/osgi/osgi.core.jar" />
		<pathelement path="build/plugins/org.eclipse.osgi/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.launcher/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.simpleconfigurator.manipulator/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.updatesite/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.publisher/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.core/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.artifact.repository/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.metadata/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.app/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.metadata.repository/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.repository/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.repository.tools/@dot" />
		<pathelement path="build/plugins/org.eclipse.equinox.p2.repository.tools/lib/repository-tools-ant.jar" />
	</path>
	<target name="compilelibs">
		<ant antfile="build.xml"
		     target="build.nativeLibraries"
		     dir="build/plugins/org.eclipse.swt.gtk.linux.${buildArch}" />

		<property name="launcherlibs"
		          value="build/features/org.eclipse.equinox.executable" />
		<exec dir="${launcherlibs}/library/gtk/"
		      executable="sh"
		      failonerror="true">
			<arg line="build.sh" />
		</exec>
		<copy file="${launcherlibs}/library/gtk/eclipse"
		      todir="build/eclipse/" />

		<property name="launcherfragment"
		          value="org.eclipse.equinox.launcher.gtk.linux.${buildArch}" />

		<copy file="${launcherlibs}/library/gtk/eclipse"
		      todir="build/features/org.eclipse.equinox.executable/contributed/gtk/linux/${buildArch}/" />
		<copy todir="build/plugins/${launcherfragment}">
			<fileset dir="${launcherlibs}/library/gtk">
				<include name="**/*.so" />
			</fileset>
		</copy>

		<!-- build liblocalfile -->
		<exec dir="build/plugins/org.eclipse.core.filesystem/natives/unix/linux"
		      executable="make"
		      failonerror="true" />
		<move file="build/plugins/org.eclipse.core.filesystem/natives/unix/linux/liblocalfile_1_0_0.so"
		      todir="build/plugins/org.eclipse.core.filesystem.linux.${buildArch}/os/linux/${buildArch}">
		</move>
		<!-- build libupdate -->
		<ant dir="build/plugins/org.eclipse.update.core.linux/src"
		     antfile="build.xml" />

	</target>

	<target name="assemble" depends="buildAll, compilelibs">
		<java classname="org.eclipse.equinox.launcher.Main"
		      fork="true"
		      dir="bootstrap"
		      failonerror="true">
			<classpath>
				<pathelement location="bootstrap/plugins/org.eclipse.equinox.launcher" />
			</classpath>
			<arg line="-configuration configuration " />
			<arg line="-application org.eclipse.ant.core.antRunner " />
			<arg line="-buildfile ../assemble-p2.xml" />
			<arg line="-debug -consoleLog " />
			<arg line="-DbuildArch=${buildArch} " />
		</java>
	</target>

	<target name="insert-ecf" depends="assemble">
		<zip destfile="build/3.5/org.eclipse.sdk-3.5M6-linux.gtk.x86.zip"
		     update="true">
			<zipfileset dir="build/plugins"
			            includes="org.eclipse.ecf*.jar"
			            prefix="eclipse/plugins" />
		</zip>
	</target>
</project>
