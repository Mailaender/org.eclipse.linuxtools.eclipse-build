<project name="Pdebuild bootstrap" default="cleanBuild" basedir=".">
	<property name="javacFailOnError" value="true" />
	<target name="cleanBuild" depends="clean,buildAll" />
	<property name="fileName" value="SDK" />
	<property file="build.properties" />
	<available file="${fileName}" property="fetched" value="true" />
	<!-- Order in this filelist is critical for building !!! -->
	<filelist id="depsDirs" dir="SDK/plugins">
		<file name="org.eclipse.osgi" />
		<file name="org.eclipse.equinox.common" />
		<file name="org.eclipse.core.jobs" />
		<file name="org.eclipse.equinox.registry" />
		<file name="org.eclipse.equinox.preferences" />
		<file name="org.eclipse.core.runtime.compatibility.auth" />
		<file name="org.eclipse.equinox.app" />
		<file name="org.eclipse.core.contenttype" />
		<file name="org.eclipse.core.runtime" />
		<file name="org.eclipse.core.variables" />
		<file name="org.eclipse.ant.core" />
		<file name="org.eclipse.equinox.security" />
		<file name="org.eclipse.core.net" />
		<file name="org.eclipse.update.configurator" />
		<file name="org.eclipse.core.runtime.compatibility" />
		<file name="org.eclipse.equinox.p2.core" />
		<file name="org.eclipse.equinox.p2.jarprocessor" />
		<file name="org.eclipse.equinox.frameworkadmin" />
		<file name="org.eclipse.equinox.frameworkadmin.equinox" />
		<file name="org.eclipse.equinox.p2.metadata" />
		<file name="org.eclipse.equinox.p2.artifact.repository" />
		<file name="org.eclipse.equinox.p2.metadata.repository" />
		<file name="org.eclipse.equinox.p2.publisher" />
		<file name="org.eclipse.equinox.simpleconfigurator" />
		<file name="org.eclipse.equinox.simpleconfigurator.manipulator" />
		<file name="org.eclipse.equinox.p2.updatesite" />
		<file name="org.eclipse.pde.build" />
		<file name="org.eclipse.equinox.launcher" />
		<file name="org.eclipse.osgi.services" />
	</filelist>
	<fileset dir="SDK/plugins" id="orbitDeps">
		<include name="org.junit_*/" />
		<include name="com.ibm.icu_*" />
		<include name="org.eclipse.ecf*" />
		<include name="org.apache.ant_*/**" />
		<include name="org.mortbay.jetty*" />
		<include name="org.apache.lucene*" />
	</fileset>
	<fileset id="depsZips" dir="SDK/plugins" includes="**/*_*.zip">
	</fileset>
	<target name="fetch" unless="fetched">
		<ant antfile="fetch.xml" />
	</target>
	<target name="bootstrap" depends="fetch">
		<subant>
			<filelist refid="depsDirs" />
		</subant>
	</target>
	<target name="zipPlugins" depends="bootstrap">
		<taskdef name="eclipse.versionReplacer"
		         classname="org.eclipse.pde.internal.build.tasks.GenericVersionReplacer"
		         classpathref="pdebuildClasspath" />
		<subant target="zip.plugin">
			<filelist refid="depsDirs" />
		</subant>
	</target>
	<condition property="bootstap.ready">
		<and>
			<available file="build/plugins" />
		</and>
	</condition>
	<target name="collectBootstrapPlugins" depends="zipPlugins">
		<mkdir dir="bootstrap/plugins" />
		<copy todir="bootstrap/plugins" flatten="true">
			<fileset refid="depsZips" />
		</copy>
		<unzip dest="bootstrap/plugins">
			<fileset dir="bootstrap/plugins">
				<include name="**/*.zip" />
			</fileset>
		</unzip>
		<delete>
			<fileset dir="bootstrap/plugins">
				<include name="**/*.zip" />
			</fileset>
		</delete>
		<copy todir="bootstrap/plugins" flatten="false">
			<fileset refid="orbitDeps" />
		</copy>
	</target>
	<target name="clean" depends="fetch">
		<subant target="clean">
			<filelist refid="depsDirs" />
		</subant>
		<delete dir="bootstrap/plugins" />
		<delete dir="build" />
	</target>
	<path id="pdebuildClasspath">
		<pathelement location="SDK/plugins/org.eclipse.pde.build/lib/pdebuild-ant.jar" />
		<pathelement location="SDK/plugins/org.eclipse.pde.build/pdebuild.jar" />
		<pathelement path="SDK/plugins/org.eclipse.equinox.common/@dot" />
		<pathelement path="SDK/plugins/org.eclipse.core.runtime/@dot" />
		<pathelement location="SDK/plugins/org.eclipse.osgi/osgi/osgi.core.jar" />
		<pathelement path="SDK/plugins/org.eclipse.osgi/@dot" />
		<pathelement path="SDK/plugins/org.eclipse.equinox.launcher/@dot" />
		<pathelement path="SDK/plugins/org.eclipse.equinox.simpleconfigurator.manipulator/@dot" />
		<pathelement path="SDK/plugins/org.eclipse.equinox.p2.updatesite/@dot" />
	</path>
	<target name="prepareBuildScriptGeneration"
	        unless="bootstrap.ready"
	        depends="collectBootstrapPlugins">
		<delete dir="build" />
		<mkdir dir="build/features" />
		<mkdir dir="build/plugins" />
		<copy todir="build/plugins/">
			<fileset dir="SDK/plugins/">
				<exclude name="**/*.source_*/" />
			</fileset>
		</copy>
		<copy todir="build/features/">
			<fileset dir="SDK/features/">
				<exclude name="**/*.source/" />
			</fileset>
		</copy>
		<!-- TODO is it really needed -->
		<move tofile="build/plugins/org.junit"
		      file="build/plugins/org.junit_3.8.2.v20080602-1318" />
	</target>
	<target name="generateBuildScripts" depends="prepareBuildScriptGeneration">
		<java classname="org.eclipse.equinox.launcher.Main"
		      fork="true"
		      dir="bootstrap"
		      failonerror="true">
			<classpath>
				<pathelement location="bootstrap/plugins/org.eclipse.equinox.launcher_1.0.200.v20090128-1500" />
			</classpath>
			<arg line="-configuration configuration " />
			<arg line="-application org.eclipse.ant.core.antRunner " />
			<arg line="-buildfile ../generatebuild.xml" />
			<arg line="-debug -consoleLog " />
		</java>
	</target>
	<target name="copyToBuild" depends="generateBuildScripts">
		<!-- Copy back the original features because they get borked during source features generation. -->
		<copy todir="build/features/" overwrite="true">
			<fileset dir="SDK/features/">
				<exclude name="**/*.source/" />
			</fileset>
		</copy>
	</target>

	<target name="buildAll" depends="copyToBuild">
		<!--FIXME Ugly hack due to 3.5M5 can't compile sdk without first compilint whatever possible from platform. -->
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.platform"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="build.jars" />
			<property name="javacSource" value="1.5" />
			<property name="javacTarget" value="1.5" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
			<property name="javacFailOnError" value="false" />
		</ant>
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.help"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="build.jars" />
			<property name="javacSource" value="1.5" />
			<property name="javacTarget" value="1.5" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
		</ant>
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.platform"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="clean" />
			<property name="javacSource" value="1.5" />
			<property name="javacTarget" value="1.5" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
		</ant>
		<!-- END OF HACK -->
		<ant antfile="build.xml"
		     dir="build/features/org.eclipse.sdk"
		     target="all.children"
		     inheritall="true">
			<property name="target" value="build.jars" />
			<property name="javacSource" value="1.5" />
			<property name="javacTarget" value="1.5" />
			<property name="ws" value="gtk" />
			<property name="os" value="linux" />
			<property name="arch" value="${buildArch}" />
		</ant>
	</target>
	<target name="jarIn">
		<taskdef name="eclipse.versionReplacer"
		         classname="org.eclipse.pde.internal.build.tasks.GenericVersionReplacer"
		         classpathref="pdebuildClasspath" />
		<taskdef name="eclipse.idReplacer"
		         classname="org.eclipse.pde.internal.build.tasks.IdReplaceTask"
		         classpathref="pdebuildClasspath" />
		<taskdef name="eclipse.brand"
		         classname="org.eclipse.pde.internal.build.tasks.BrandTask"
		         classpathref="pdebuildClasspath" />
		<ant antfile="assemble.org.eclipse.sdk.linux.gtk.${buildArch}.xml" dir="build">
			<property name="buildLabel" value="3.5" />
			<property name="buildId" value="3.5M5" />
			<property name="collectingFolder" value="collected" />
			<property name="archivePrefix" value="eclipse" />
		</ant>
	</target>
</project>