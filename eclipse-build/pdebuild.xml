<project name="Pdebuild bootstrap" default="cleanBuild" basedir=".">
	<target name="cleanBuild" depends="clean,zipPlugins2" />
	<property file="pdebuild.properties" />
	<property name="sdkSource" value="build/eclipse-${buildId}-fetched-src" />
	<!-- Order in this filelist is critical for building !!! -->
	<filelist id="depsDirs" dir="${sdkSource}/plugins">
		<file name="org.eclipse.osgi" />
		<file name="org.eclipse.equinox.common" />
		<file name="org.eclipse.core.jobs" />
		<file name="org.eclipse.equinox.registry" />
		<file name="org.eclipse.equinox.preferences" />
		<file name="org.eclipse.core.runtime.compatibility.auth" />
		<file name="org.eclipse.core.contenttype" />
		<file name="org.eclipse.equinox.app" />
		<file name="org.eclipse.core.runtime" />
		<file name="org.eclipse.core.variables" />
		<file name="org.eclipse.ant.core" />
		<file name="org.eclipse.equinox.p2.core" />
		<file name="org.eclipse.equinox.p2.metadata" />
		<file name="org.eclipse.equinox.frameworkadmin" />
		<file name="org.eclipse.equinox.frameworkadmin.equinox" />
		<file name="org.eclipse.equinox.p2.jarprocessor" />
		<file name="org.eclipse.equinox.security" />
		<file name="org.eclipse.equinox.p2.repository" />
		<file name="org.eclipse.equinox.p2.artifact.repository" />
		<file name="org.eclipse.equinox.p2.metadata.repository" />
		<file name="org.eclipse.equinox.p2.publisher" />
		<file name="org.eclipse.equinox.simpleconfigurator" />
		<file name="org.eclipse.equinox.simpleconfigurator.manipulator" />
		<file name="org.eclipse.update.configurator" />
		<file name="org.eclipse.core.runtime.compatibility" />
		<file name="org.eclipse.equinox.p2.engine" />
		<file name="org.eclipse.equinox.p2.director" />
		<file name="org.eclipse.equinox.p2.repository.tools" />
		<file name="org.eclipse.equinox.p2.updatesite" />
		<file name="org.eclipse.pde.build" />
		<file name="org.eclipse.equinox.launcher" />
		<file name="org.eclipse.osgi.services" />
		<file name="org.eclipse.equinox.p2.console" />
		<file name="org.eclipse.equinox.p2.director.app" />
		<file name="org.eclipse.core.net" />
		<file name="org.eclipse.update.core" />
		<file name="org.eclipse.equinox.p2.garbagecollector" />
		<file name="org.eclipse.equinox.p2.exemplarysetup" />
		<file name="org.eclipse.core.expressions" />
		<file name="org.eclipse.equinox.http.servlet" />
		<!--<file name="org.eclipse.equinox.http.jetty_2.0.0" />-->
		<!--
		<file name="org.eclipse.help" />
		<file name="org.eclipse.help.base" />
		-->
	</filelist>
	<filelist id="helpDirs" dir="${sdkSource}/plugins">
			<file name="org.eclipse.equinox.http.jetty_1.1.100" />
			<file name="org.eclipse.equinox.http.jetty_2.0.0" />
			<file name="org.eclipse.help" />
			<file name="org.eclipse.help.base" />
	</filelist>
	<filelist id="depsDirs2" dir="${sdkSource}/plugins">
		<file name="org.eclipse.swt.gtk.linux.${buildArch}" />
		<file name="org.eclipse.core.filesystem" />
		<file name="org.eclipse.core.resources" />
		<file name="org.eclipse.core.commands" />
		<file name="org.eclipse.jface" />
		<file name="org.eclipse.text" />
		<file name="org.eclipse.jface.text" />
		<file name="org.eclipse.team.core" />
		<file name="org.eclipse.core.filebuffers" />
		<file name="org.eclipse.debug.core" />
		<file name="org.eclipse.jdt.core" />
		<file name="org.eclipse.jdt.debug" />
		<file name="org.eclipse.jdt.launching" />
		<file name="org.eclipse.pde.core" />
		<file name="org.eclipse.pde.api.tools" />
	</filelist>
	<fileset dir="${sdkSource}/plugins" id="orbitDeps">
		<include name="org.junit_*/" />
		<include name="com.ibm.icu_*" />
		<include name="org.eclipse.ecf*" />
		<include name="org.apache.ant_*/**" />
		<include name="org.mortbay.jetty*" />
		<include name="org.apache.lucene*" />
		<include name="org.sat4j*" />
		<include name="org.hamcrest.core*" />
		<include name="javax.servlet*" />
		<include name="org.objectweb.asm*" />
	</fileset>
	<path id="pdebuildClasspath">
		<pathelement location="${sdkSource}/plugins/org.eclipse.pde.build/lib/pdebuild-ant.jar" />
		<pathelement location="${sdkSource}/plugins/org.eclipse.pde.build/pdebuild.jar" />
		<pathelement path="${sdkSource}/plugins/org.eclipse.equinox.common/@dot" />
		<pathelement path="${sdkSource}/plugins/org.eclipse.core.runtime/@dot" />
		<pathelement location="${sdkSource}/plugins/org.eclipse.osgi/osgi/osgi.core.jar" />
		<pathelement path="${sdkSource}/plugins/org.eclipse.osgi/@dot" />
		<pathelement path="${sdkSource}/plugins/org.eclipse.equinox.launcher/@dot" />
		<pathelement path="${sdkSource}/plugins/org.eclipse.equinox.simpleconfigurator.manipulator/@dot" />
		<pathelement path="${sdkSource}/plugins/org.eclipse.equinox.p2.updatesite/@dot" />
	</path>
	<fileset id="depsZips" dir="${sdkSource}/plugins" includes="**/*_*.zip" />
	<target name="generateScripts">
		<pathconvert pathsep=", " property="plugins">
			<filelist refid="depsDirs" />
			<mapper>
				<chainedmapper>
					<flattenmapper />
					<globmapper from="*" to="plugin@*" />
				</chainedmapper>
			</mapper>
		</pathconvert>
		<eclipse.buildScript elements="${plugins}"
		                     builddirectory="${sdkSource}" />
		<!-- FIXME:  don't blindly use /tmp -->
		<move file="${sdkSource}/plugins/org.eclipse.equinox.http.jetty_1.1.100" todir="/tmp"/>
		<eclipse.buildScript elements="plugin@org.eclipse.equinox.http.jetty"
		                     significantVersionDigits="2.0.0"
		                     builddirectory="${sdkSource}" />
		<move file="/tmp/org.eclipse.equinox.http.jetty_1.1.100" todir="${sdkSource}/plugins"/>
		<eclipse.buildScript elements="plugin@org.eclipse.equinox.http.jetty"
							 significantVersionDigits="1.1.100"
		                     builddirectory="${sdkSource}" />
		<eclipse.buildScript elements="plugin@org.eclipse.help.base"
		                     builddirectory="${sdkSource}" />
		<eclipse.buildScript elements="plugin@org.eclipse.help"
		                     builddirectory="${sdkSource}" />
	</target>
	<target name="generateScripts2">
		<pathconvert pathsep=", " property="plugins">
			<filelist refid="depsDirs2" />
			<mapper>
				<chainedmapper>
					<flattenmapper />
					<globmapper from="*" to="plugin@*" />
				</chainedmapper>
			</mapper>
		</pathconvert>

		<eclipse.buildScript elements="${plugins}"
		                     builddirectory="../build/eclipse-I20090611-1540-fetched-src" />
	</target>
	<target name="bootstrap">
	<echo message="CDC-1.1/Foundation-1.1 = ${CDC-1.1/Foundation-1.1}"/>
		<subant>
			<filelist refid="depsDirs" />
		</subant>
		<subant>
			<filelist refid="helpDirs" />
		</subant>
	</target>
	<target name="bootstrap-clean">
		<subant target="clean">
			<filelist refid="depsDirs" />
		</subant>
		<subant target="clean">
			<filelist refid="helpDirs" />
		</subant>
	</target>
	<target name="bootstrap2" depends="zipPlugins">
		<antcall target="collectBootstrapPlugins" />
		<java classname="org.eclipse.equinox.launcher.Main"
		      fork="true"
		      dir="bootstrap"
		      failonerror="true">
			<classpath>
				<pathelement path="bootstrap/plugins/org.eclipse.equinox.launcher.jar" />
			</classpath>
			<arg line="-configuration configuration " />
			<arg line="-application org.eclipse.ant.core.antRunner " />
			<arg line="-buildfile ../pdebuild.xml generateScripts2" />
			<arg line="-DbuildArch=${buildArch} " />
			<arg line="-DbuildId=${buildId} " />
			<arg line="-debug -consolelog " />
		</java>
		<taskdef name="eclipse.versionReplacer"
		         classname="org.eclipse.pde.internal.build.tasks.GenericVersionReplacer"
		         classpathref="pdebuildClasspath" />
		<subant>
			<filelist refid="depsDirs2" />
		</subant>
	</target>
	<target name="cleanBuilded">
		<subant target="clean">
			<filelist refid="depsDirs2" />
		</subant>
	</target>
	<target name="zipPlugins" depends="bootstrap">
		<taskdef name="eclipse.versionReplacer"
		         classname="org.eclipse.pde.internal.build.tasks.GenericVersionReplacer"
		         classpathref="pdebuildClasspath" />
		<subant target="zip.plugin">
			<filelist refid="depsDirs" />
		</subant>
		<subant target="zip.plugin">
			<filelist refid="helpDirs" />
		</subant>
	</target>
	<target name="zipPlugins2" depends="bootstrap2">
		<taskdef name="eclipse.versionReplacer"
		         classname="org.eclipse.pde.internal.build.tasks.GenericVersionReplacer"
		         classpathref="pdebuildClasspath" />
		<subant target="zip.plugin">
			<filelist refid="depsDirs2" />
		</subant>
		<antcall target="collectBootstrapPlugins" />
	</target>
	<target name="collectBootstrapPlugins" >
		<mkdir dir="bootstrap/plugins" />
		<copy todir="bootstrap/plugins" flatten="true">
			<fileset refid="depsZips" />
		</copy>
		<unzip dest="bootstrap/plugins">
			<fileset dir="bootstrap/plugins">
				<include name="**/*.zip" />
			</fileset>
		</unzip>
		<delete>
			<fileset dir="bootstrap/plugins">
				<include name="**/*.zip" />
			</fileset>
		</delete>
		<copy todir="bootstrap/plugins" flatten="false">
			<fileset refid="orbitDeps" />
		</copy>
		<!-- symlink o.e.osgi to o.e.osgi_<VERSION> -->
		<dirset dir="bootstrap/plugins"
		        includes="org.eclipse.osgi_*"
		        id="osgitest" />

		<property name="osgiplugin" refid="osgitest" />
		<echo message="${osgiplugin}" />

		<symlink link="bootstrap/plugins/org.eclipse.osgi"
		         resource="${osgiplugin}"
		         overwrite="true" />
		<!-- symlink o.e.equinox.launcher to o.e.equinox.launcher_<VERSION> -->
		<dirset dir="bootstrap/plugins"
		        includes="org.eclipse.equinox.launcher_*"
		        id="launcher" />

		<property name="launcherplugin" refid="launcher" />
		<echo message="${launcherplugin}" />

		<symlink link="bootstrap/plugins/org.eclipse.equinox.launcher"
		         resource="${launcherplugin}"
		         overwrite="true" />
		<jar destfile="bootstrap/plugins/org.eclipse.equinox.launcher.jar"
		     basedir="bootstrap/plugins/org.eclipse.equinox.launcher"
		     includes="**"
		     manifest="bootstrap/plugins/org.eclipse.equinox.launcher/META-INF/MANIFEST.MF">
		</jar>
	</target>
	<target name="clean">
		<delete dir="bootstrap/plugins" />
		<delete dir="bootstrap/configuration/org.eclipse.core.runtime" />
		<delete dir="bootstrap/configuration/org.eclipse.equinox.app" />
		<delete dir="bootstrap/configuration/org.eclipse.osgi" />
		<delete dir="bootstrap/configuration/org.eclipse.update" />
		<delete dir="bootstrap/workspace" />
		<delete dir="bootstrap/p2" />
	</target>
</project>
